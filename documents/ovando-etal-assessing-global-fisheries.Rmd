---
title: |
  | Status of Global Unassessed Fisheries will Remain Highly Uncertain
  | without Better Data
author: 
  - Daniel Ovando
  - Ray Hilborn
  - Cole Monnahan
  - Merrill Rudd
  - Rishi Sharma
  - James Thorson
  - Yannick Rousseau
  - Yimin Ye
date: "`r Sys.Date()`"
bibliography: ["../references.bib"]
csl: nature-communications.csl
output: 
  bookdown::pdf_document2:
    latex_engine: xelatex
  bookdown::word_document2:
    reference_docx: SA_MS_Template_2020.docx
params:
  results_name: ["v1.0"]
  min_years_catch: [25]
abstract: |
  Assessments of the global state of fisheries play an important role in tracking the implementation of the United Nations Sustainable Development Goals. While we have reliable estimates of stock status for fisheries accounting for approximately half of recent global catch, our knowledge of the state of the majority of the word's 'unassessed' fisheries remains highly uncertain. Numerous high-profile publications have produced estimates of the global status of these unassessed fisheries, but limited quantity and quality of data along with methodological differences have produced counterintuitive and conflicting results. Here, we show that despite numerous efforts, our understanding of the status of global fisheries remains incomplete, even when new sources of broadly available data are added. Obtaining accurate estimates of stock status for the world's fisheries depends on prioritizing the collection of high-priority data around the globe, rather than the development of new modeling methods alone.
always_allow_html: true
linkcolor: blue
# header-includes:
#   - \usepackage{draftwatermark}
#   - \SetWatermarkText{DRAFT}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, dpi = 600,
                      cache = FALSE, fig.width = 6, fig.asp = .75, dev = "png")
library(tidyverse)
library(viridis)
library(sf)
library(hrbrthemes)
library(extrafont)
library(scales)
library(patchwork)
library(rstanarm)
library(bayesplot)
library(here)
library(sraplus)
extrafont::loadfonts()

functions <- list.files(here::here("functions"))

purrr::walk(functions, ~ source(here::here("functions", .x)))

results_name <- params$results_name

results_path <- here("results",results_name)

min_years_catch <- params$min_years_catch

prepare_sofia_data(lookup_fmi_names = FALSE)

ram_comp_data <- ram_data %>%
  mutate(has_things = !(is.na(catch) | catch == 0)) %>%
  filter(has_things) %>%
  group_by(stockid) %>%
  mutate(delta_year = as.integer(year - lag(year))) %>%
  mutate(delta_year = case_when(year == min(year) ~ as.integer(1),
                                TRUE ~ delta_year)) %>%
  mutate(missing_gaps = any(delta_year > 1)) %>%
  filter(missing_gaps == FALSE) %>%
  group_by(stockid) %>%
  mutate(n = length(catch)) %>%
  filter(n >= min_years_catch) %>%
  ungroup()

ram_comp_data <- ram_comp_data %>%
  select(
    year,
    stockid,
    country,
    primary_FAOarea,
    scientificname,
    commonname,
    year,
    catch,
    b_v_bmsy,
    u_v_umsy,
    total_biomass
  ) %>%
  rename(scientific_name = scientificname) %>% 
  mutate(fao_area_code = as.numeric(primary_FAOarea)) %>% 
  left_join(fao_species, by = "scientific_name")


assess_ram_fits <- read_rds(path = file.path(results_path,"assess_ram_fits.rds"))

ram_v_sraplus_area <- read_rds(path = file.path(results_path,"ram_v_sraplus_area.rds"))

ram_comp_data <- read_rds(path = file.path(results_path,"ram_comp_data.rds"))

fao_sraplus_comp_data <- read_rds(path = file.path(results_path, "fao_sraplus_comp_data.rds"))


load(file = file.path(results_path, "paper_plots.Rdata"))

load(file = file.path(results_path, "voi_fits.RData"))

  exs <- read_rds(path = file.path(results_path, "raw-case-study-fits.rds"))


breaks <- c(0.8, 1.2)

breaks <- c(0, breaks, Inf)

labels <- c("over", "fully", "under")


# rand_fits <- assess_ram_fits %>%
#   filter(data == "ram-data") %>%
#   mutate(mean = sample(c(0.1, 1, 2), n(), replace = TRUE),
#          data = "guess")


perf <- assess_ram_fits %>% 
  # bind_rows(rand_fits) %>% 
  mutate(sraplus_bin = cut(mean, breaks = breaks, labels = labels)) %>%
  mutate(ram_bin = cut(ram_b_v_bmsy, breaks = breaks, labels = labels)) %>%
  mutate(data = as.factor(data)) %>% 
  mutate(data = forcats::fct_recode(data, 
                                    "RAM Index" = "ram-data",
                                    "SAR" = "sar",
                                    "FMI" = "fmi",
                                    "Effective CPUE" = "cpue",
                                    "Effective CPUE+" = "cpue-plus",
                                    "Nominal CPUE" = "nominal-cpue",
                                    "Nominal CPUE+" ="nominal-cpue-plus",
                                    "CMSY" = "cmsy",
                                    "Guess" = "guess",
                                    "RAM U/Umsy" = "u_umsy"
                                     
                                    )) %>% 
  group_by(data) %>% 
  summarise(
    mpe = median((mean - ram_b_v_bmsy ) / ram_b_v_bmsy),
    mape = median(abs(mean - ram_b_v_bmsy ) / ram_b_v_bmsy),
    accuracy = mean(ram_bin == sraplus_bin, na.rm = TRUE)
  ) %>% 
  arrange((mape)) %>% 
  rename("Data Used" = "data")



fao_area_codes <- fao %>% 
  ungroup() %>% 
  select(fao_area, fao_area_code) %>% 
  unique()



pub_theme <- theme_ipsum(base_size = 10,
                         axis_text_size = 10,
                         axis_title_size = 12) +
    theme(panel.spacing = unit(.5,"lines"))

theme_set(pub_theme)


```

<!-- # rishi notes -->

<!-- * more assertive on what the data needs really are -->

<!--   * where to apply globally  -->

<!-- * For places with less coverage, what would we actually recommend there  -->

<!-- * what do we know about catchabiliy -->

<!-- - e.g. 51, fleets became industrial  -->

<!--   - hammer down on that's the issue with the effort  -->

<!--   - how do we translate effort into f bey area -->

<!--   - here's  -->

<!-- https://www.nature.com/natsustain/about/content -->

<!-- # check in call notes -->

<!-- Ray: setting the stage: what we want is a way to assess the status of stocks and see how we're doing relative to SDG. -->

<!-- We need to discuss a sampling strategy: how can we get down to a set of priority stock. A step of expert knowledge to refine what stocks you would focus in on. -->

<!-- Regressions based approach, focusing in effort on stocks -->

<!-- Basically a paragraph laying out that we need to do this, and discussing how we might go about doing that. Equal weight to each stock vs proportional to biomass -->

<!-- add in a bit more to the discussion on guidelines -->

<!-- add in error in the index for the VOI analysis -->

<!-- Apples and apples comparisons between model and design developments. How much is the value of the effort data relative to actually improving the population model. Production model is ill-suited to some of these questions. -->

<!-- fishing effort uncertainty of the effort -->

<!-- how credible is the information -->

<!-- probably don't need to bother with the SAUP -->

<!-- stock assessments -->

<!-- the stock will collapse next year -->

<!-- nansen data -->

<!-- # Publication Requirements -->

<!-- Target Journal: [Nature Sustainability](https://www.nature.com/natsustain/about/content) -->

<!-- 3500 words main text -->

<!-- 50 references (main text) -->

<!-- 3000 words (max) methods -->

# Introduction

The United Nations Sustainable Development Goal 14 (SDG 14), focusing on "Life under water", calls for the global community to "Conserve and sustainably use the oceans, seas and marine resources for sustainable development". Meeting these targets depends in part on our ability to effectively track the status of global marine fish stocks. The Food and Agriculture Organization of the United Nations' (FAO) is the custodian agency of the dedicated SDG 14 Indicator on fisheries sustainability, and the FAO's report on the State of World Fisheries and Aquaculture (SOFIA) report is the most widely used source for tracking the global state of fisheries. As of the most recent report, the FAO estimates that as of 2017 59.6% of marine fish stocks are maximally sustainably fished, 6.2% are underfished, and 34.2% are overfished [@fao2020]. The SOFIA assessment was designed in the 1970s based on the then available data and methods, With the surge in data availability, such as global assessments of management strength, trawl footprints, and fishing effort, and modeling methods,the SOFIA global assessment methods need to be further strengthened to meet the demand for estimation and tracking progress towards the SDG goals.

The FAO's SOFIA index captures 70% of the landings of all fisheries in the world, with statements on on individual stock status made on the basis of formal stock assessments where available, and through a combination of other methods where not [@fao2020]. In this paper we evaluate the ability of alternative data-limited assessment models to improve the methods used by the FAO for these unassessed stocks. While these unassessed stocks are generally individually smaller than the typically larger and more valuable stocks in the assessed category, collectively they are a vital source of food, employment, cultural value, and ecosystem services around the world.

The SOFIA report includes unassessed stocks and bases its estimates for these fisheries on data-limited methods or qualitative expert opinion for each region where these stocks are distributed. While these methods combined with local knowledge can be well informed as to the status of their fish stocks, a more quantitatively vetted process would be desirable in order to increase reproducibility, transparency, and potential reliability. Numerous studies in recent years have put forward versions of "data-limited" models that have attempted to provide estimates for the global status of these unassessed stocks [@costello2012b; @costello2016a; @pauly2007; @rosenberg2018; @thorson2012a]. Due to data limitations, all of these global assessment efforts use forms of "catch-only" stock assessment models (Free et al. 2020 [@free2020] and references therein). These models seek to infer stock status, for example in terms of biomass *B* relative to the biomass at maximum sustainable yield *B~MSY~*, from characteristics of a fishery's catch history, for example the ratio of catch to maximum catch [@martell2013].

However, Free et al. 2020 [@free2020] demonstrated that these catch-only models can often produce both imprecise and biased estimates of current stock status in terms of B/B~MSY~. These issues become apparent when we consider some of the macro-level predictions made by these models. While the estimates B/B~MSY~ and other reference points reported in RAM are themselves model outputs subject to their own non-trivial errors and biases, a simple benchmark is to compare the estimates of fishery status from RAM to those predicted by potentially less reliable methods intended for use when insufficient data are available for a full stock assessment model.

Costello et al. 2016 [@costello2016a] finds similar rankings of regions in terms of stock status as RAM, but their estimate of state of fisheries in the Mediterranean/Black Sea regions and Southeast Asia seem to be over-optimistic, and the Northeast Pacific should be better by comparison. The superensemble method [@anderson2017a] used in Rosenberg et al. 2018 [@rosenberg2018] demonstrates the same problem, with stocks in Southeast Asia estimated as doing better than the Northeast Atlantic or Northeast Pacific. The Pauly 2007 [@pauly2007] catch-based approach finds the stocks of Southeast Asia in much better condition than those in the Northeast Pacific or Northeast Atlantic (Table.\@ref(tab:status-tab)). The methods besides RAM in Table.\@ref(tab:status-tab) include both formally assessed and unassessed stocks, and as such we would expect them to differ broadly in their estimates of regional stock status, particularly since we might expect unassessed stocks to be less rigorously managed and by extension have poorer stock status. However, the lack of consistency across heavily assessed regions such as the Northeast Pacific, and the lack of contrast in stock status between heavily and lightly managed regions is concerning.

```{r status-tab}

o_by_a <- sofia_status %>% 
  left_join(fao_area_codes, by = "fao_area_code") %>% 
  group_by(fao_area) %>% 
  summarise(`FAO % Overfished` = percent(mean(status == "O")))

ss <-
  readxl::read_xlsx(here("data", "state_space_results_08_28_2018 by region.xlsx"),
                    sheet = "state_space_results_08_28_2018") %>%
  janitor::clean_names()


ss_lookup <-
  readxl::read_xlsx(here("data", "state_space_results_08_28_2018 by region.xlsx"),
                    sheet = "ss_to_fao") %>%
  janitor::clean_names() %>% 
  mutate(tmp = map2(region, fao_area_codes, ~data.frame(region = .x, fao_area_code = as.integer(str_split(.y, pattern = ',',simplify = TRUE))))) %>% 
  select(tmp) %>% 
  unnest(cols = tmp) %>% 
    left_join(fao_area_codes, by = "fao_area_code")

state_space_results <- ss_lookup %>% 
  left_join(ss, by = "region") %>% 
  filter(variable == "BvB") %>% 
  group_by(fao_area) %>% 
  filter(year == max(year)) %>% 
  summarise(`B/BMSY RAM` = round(mean(dlm_geomean),2)) %>% 
  ungroup() 


# ram_by_region %>% 
#   ggplot(aes(b_v_bmsy)) +
#   geom_histogram() + 
#   facet_wrap(~fao_area)


readr::read_csv(here("data","status-table.csv")) %>% 
  select(-`B/BMSY RAM`) %>%  
  left_join(o_by_a, by = c("FAO Area" = "fao_area")) %>% 
  left_join(state_space_results, by = c("FAO Area" = "fao_area")) %>% 
  arrange(`FAO % Overfished`) %>% 
  select(`FAO Area`,`FAO % Overfished`, everything()) %>% 
  knitr::kable(caption = "Estimates of B/B~MSY~ by FAO, RAM Legacy Stock Assessment Database through Hilborn et al. 2020, Costello et al. 2016, 
               Rosenberg et al. 2018, and Pauly 2007",
               booktabs = TRUE,
               format = "pipe") %>% 
  kableExtra::kable_styling(full_width = T, font_size = 9) %>%
  kableExtra::row_spec(0, bold = T)

```

In this paper we ask, can combining the FAO's catch statistics with other broadly available data improve our understanding of the state of global fisheries? We use a flexible surplus-production based stock assessment software package, [`sraplus`](www.github.com/danovando/sraplus) to demonstrate how different data sources can be used to augment catch-only models at a global scale, and to evaluate how our perception of global stock status would vary depending on which sources of data we include. We show that improving our understanding of the world's unassessed fisheries depends on a redoubled effort at global data collection and synthesis.

# Results


| Data Source           |  Short Name | Data Use |  Caveats |
|-----------------------|-------------|------|------|
| Catch data [@fao2020] | catches     | Priors on stock status, scaling of population size, exploitation history    |    Heuristics or regressions used to translate shape of catch history into priors on stock status  |
|    Fisheries Management Index [@melnychuk2017]     | FMI     | Priors on most recent F/F~MSY~ values   |Priors produced by regression trained on data from RAM Legacy Stock Assessment Database|
| Swept Area Ratio [@amoroso2018]      | SAR     | Priors on most recent F/F~MSY~ values |Priors produced by regression trained on data from RAM Legacy Stock Assessment Database|
|  Reconstructed effort data [@rousseau2019b] | effort | Combined with catch data to create an index of abundance| Total reconstructed effort across all sectors. Assumed rate of technology creep reported in individual sections|
Table:(\#tab:data) Data sources included across model fits. 

We first present a case study demonstrating how different kinds of data can lead to different conclusions about stock status. From there, we assess the performance of models fit using different kinds of broadly available data: combinations of catches, effort, Fisheries Management Index (FMI) scores (a measure of management capacity), and swept area ratio (SAR) values (a measure of trawl fishing intensity) (Table.\@ref(tab:data)).

<!-- `FishLife` [@thorson2017c] provides informative priors for key life history parameters (such as growth rates) needed by our model. We use the FMI and SAR values to construct Bayesian priors on initial and terminal stock status values (e.g B/B~MSY~ or F/F~MSY~, the fishing mortality *F* relative to the fishing mortality rate that would produce *MSY* at equilibrium), allowing us to translate local values of for example SAR into a prior on terminal B/B~MSY~. Where available, we use effort data to create stock-specific timeseries of catch-per-unit-effort (CPUE), which can be used as an index of stock abundance.  -->

For our case study, we selected `r n_distinct(exs$stockid)` stocks for which we have stock specific FMI and SAR scores. We then paired effort data at the resolution of year, country, and FAO statistical area from Rousseau et al. 2019 [@rousseau2019] to each stock. As a benchmark, we first estimated stock status for these case study fisheries using the CMSY [@froese2017] method, as this has become one of the most widely used catch-only models currently available. We then used stock-specific data on SAR and FMI to generate priors on F/F~MSY~ for each of the stocks, which were then passed to sraplus. Lastly, we used the reconstructed effort data from [@rousseau2019] to create an index of abundance for each stock, and estimated stock status by fitting to this index while using priors on fishing mortality rates informed by each stock's FMI and SAR values. While CMSY systemically overestimated fishing mortality rates and underestimated stock status, use of the SAR, FMI, and effort data produced substantially more accurate results for both B/B~MSY~ and F/F~MSY~ (Fig.\@ref(fig:cs-plot)).

<!-- Nearly all of the fisheries used in this case study have F/F~MSY~ values less than one, and most have B/B~MSY~ values greater than one. CMSY, using no stock-specific information but the catch history (which defines the prior on K and stock depletion, and hence the estimate of B/B\~msy\~) and the estimated resilience of the target species (based on Fishlife ([@thorson2020])), badly misses this trend, stating instead that nearly all the fisheries in this group are currently overfished and experiencing overfishing. Adding priors informed by stock-specific the swept-area-ratio and fisheries management index data produces a dramatically different picture, capturing the general state that most of these fisheries have low fishing mortality rates and biomass near or above B~MSY~. Fitting to an index of abundance created by regional effort data in fact produces a slightly poorer fit. This is largely because a number of stocks in this case study set have very low catches (relative to historic highs) and high biomass values (Fig.\@ref(fig:cs-plot)). -->

```{r cs-plot, fig.cap="RAM values of B/B~MSY~ and F/F~MSY~ (x-axes) for case study fisheries plotted against estimated values (y-axes) using CMSY [@froese2017], priors informed by stock-specific Fisheries Management Index (FMI) and swept area ratio (SAR) scores, and an abundance index based on reconstructed effort trends assuming a rate of technological increase of 2.6%. Each point is a stock. Black dashed line shows the 1:1 relationship."}
ex_scatter_plot
```

<!-- That use of Swept Area Ratio and Fisheries Management Index data produced a more accurate estimate of stock status than catch alone should come as no surprise. In the absence of other data, the heuristics internal to CMSY linking catch to stock status, and the regressions linking SAR and FMI values to stock status, are themselves the assessment process. Since the SAR and FMI regressions were trained on the RAM stocks in question, this process simply confirms that for these stocks SAR and FMI data contain a reasonable amount of information on fishing pressure and by extension stock status. -->

We next assessed the ability of FMI, SAR, and effort data to improve estimates of global stock status. We based this test on `r ram_comp_data$stockid %>% n_distinct()` stocks from RAM, covering `r n_distinct(ram_comp_data$isscaap_group)` broad taxonomic groups, with estimates of B/B~MSY~ and greater than 25 years of continuous catch history. B/B~MSY~ values from RAM are themselves estimates, not data, but they are the best available information on global stock status. We then paired the catch histories for these RAM stocks with regional-level SAR, FMI, and effort data. This process approximates a global-level assessment exercise, where data are available at regional levels, but not for specific fisheries.

We also estimated B/B~MSY~ values of our candidate RAM stocks by using sraplus to fit to an abundance index drawn directly from RAM. We then fit a range of models utilizing different combinations FMI, SAR, and effort data, along with the CMSY method described in Froese et al. 2017 [@froese2017] (See Table.\@ref(tab:dat-desc)). We assessed performance using three metrics: median percent error (MPE, a measure of bias), median absolute percent error (MAPE, a measure of accuracy), and classification accuracy. Classification accuracy was calculated as the proportion of times that use of a given combination of data resulted in a stock being classified into the correct FAO status classification (one of underfished, maximally sustainably fished, and overfished).

Overall the sraplus estimates of B/B~MSY~ resulting from using the RAM data were relatively accurate and unbiased at a macro level (MPE `r percent(perf$mpe[perf$"Data Used" == "ram-data"])`,MAPE `r percent(perf$mape[perf$"Data Used" == "ram-data"])`, accuracy = `r percent(perf$accuracy[perf$"Data Used" == "ram-data"])`, Table.\@ref(tab:perf-tab), Fig.\@ref(fig:mpe-map)-\@ref(fig:acc-map)). This exercise tells us that given sufficiently high quality data, a surplus production model such as sraplus is reasonably capable of reproducing the global state of fisheries as understood from formally assessed fisheries.

Performance limitations then are likely to arise less from model misspecification than from the quality of the data themselves. This becomes clearer once we consider the performance of sraplus models fit to combinations of our broadly available datasets. Many of the datasets used produced similar levels of bias as the RAM data (Table.\@ref(tab:perf-tab)). However, this is somewhat an artifact of the data. The status of most stocks in RAM is also relatively good, with recent B/B~MSY~ values generally near one. This means that a model that more or less reproduces the global average of stock status will be relatively unbiased on average, but imprecise. Focusing on MAPE instead, the error of the models jumps dramatically as soon as data other than RAM are used, to a minimum value of `r percent(perf$mape[2])` and a maximum of `r percent(max(perf$mape))`. The mean accuracy of the sraplus models across all non-RAM data fits was only `r percent(mean(perf$accuracy[!perf$"Data Used" %in% c("ram-data","guess")]))`. Note that there are only three bins in the FAO stock status classifications, and a "model" that randomly assigns a stock to a status category has a mean accuracy of `r percent(perf$accuracy[perf$"Data Used" == "guess"])`.

Looking geographically we see a similar pattern of a rapid decrease in performance for models using non-RAM data intended to simulate a global assessment process. Across the models, performance was not consistent in space: use of different data performed best or worst for different FAO regions. For example, models fit to nominal CPUE data substantially overestimate stock status in the Mediterranean, while models based on data using effective CPUE perform better in that region (but worse in others) Fig.\@ref(fig:mape-map). We find similarly inconsistent performance for both bias (Fig.\@ref(fig:mpe-map)) and accuracy (Fig.\@ref(fig:acc-map)). Overall, while some data sources performed slightly better than others by some metrics in some places, no models using any non-RAM data were able to capture the overall state or geographic distribution of stock status represented in RAM in a consistently satisfactory manner.

```{r perf-tab}

knitr::kable(perf, digits = 2,
             caption = "Global performance statistics in the most recent year available of models using different sources of data. mpe = median percent error (bias), mape = median absolute percent error (error), accuracy = percent of times that stocks were classified to the correct FAO status bin (underfished, maximally sustainably fished, overfished). Performance is judged relative to reported values in RAM Legacy Stock Assessment Database. See Table.5 for details of data types.",
              format = "pipe")

```

<!-- xx dig into this, which stocks are in that region? XX -->

```{r mpe-map, fig.width=8, fig.height=8, fig.cap="Median percent error in most recent B/B~MSY~ by FAO statistical area from different data sources. RAM Index refers to catch and abundance index drawn from RAM. Effective CPUE refers to an index of abundance based on reconstructed effort data. Effective CPUE+ uses CPUE along with Fisheries Management Index (FMI) and/or swept area ratio (SAR) data. For both CPUE series 'nominal' assumes a 0% technology creep, for effective a 2.6% technology creep is assumed. RAM U/U~MSY~ assumes all fisheries in the region share a common U/U~MSY~ series with formally assessed fisheries in the region. FMI uses FMI scores to develop a prior on recent fishing mortality rates, SAR does the same but based on swept area ratio. CMSY uses the methods from Froese et al. 2017 [@froese2017]. Guess assignes a random recent B/B~MSY~ of 0.4,1, or 1.6."}
ram_mpe_map_plot
```

```{r mape-map, fig.cap = "Median absolute percent error in most recent B/B~MSY~ by FAO statistical area from different data sources. RAM Index refers to catch and abundance index drawn from RAM. Effective CPUE refers to an index of abundance based on reconstructed effort data. Effective CPUE+ uses CPUE along with Fisheries Management Index (FMI) and/or swept area ratio (SAR) data. For both CPUE series 'nominal' assumes a 0% technology creep, for effective a 2.6% technology creep is assumed. RAM U/U~MSY~ assumes all fisheries in the region share a common U/U~MSY~ series with formally assessed fisheries in the region. FMI uses FMI scores to develop a prior on recent fishing mortality rates, SAR does the same but based on swept area ratio. CMSY uses the methods from Froese et al. 2017 [@froese2017]. Guess assignes a random recent B/B~MSY~ of 0.4,1, or 1.6."}
ram_mape_map_plot
```

```{r acc-map, fig.cap="Mean classification accuracy (assignment to FAO stock status category) by FAO statistical area arising from different data sources. RAM Index refers to catch and abundance index drawn from RAM. Effective CPUE refers to an index of abundance based on reconstructed effort data. Effective CPUE+ uses CPUE along with Fisheries Management Index (FMI) and/or swept area ratio (SAR) data. For both CPUE series 'nominal' assumes a 0% technology creep, for effective a 2.6% technology creep is assumed. RAM U/U~MSY~ assumes all fisheries in the region share a common U/U~MSY~ series with formally assessed fisheries in the region. FMI uses FMI scores to develop a prior on recent fishing mortality rates, SAR does the same but based on swept area ratio. CMSY uses the methods from Froese et al. 2017 [@froese2017]. Guess assignes a random recent B/B~MSY~ of 0.4,1, or 1.6."}

ram_acc_map_plot 
```

\newpage

The poor global performance of models fit to currently accessible broadly available datasets, relative to models fit to data from RAM, indicates that we must prioritize collection and aggregation of new or underutilized data sources if we are to improve our estimates of global fishery status. What sources of data might provide the greatest value in improving our estimates of global stock status? We used sraplus together with the RAM database to estimate the average reduction in error resulting from having access to different kinds of data (Fig.\@ref(fig:voi-plot)). While having access to complete index of abundance, such as a fishery independent survey, was on average able to reduce error relative to a baseline catch-only heuristic, using only the most recent quarter of the available abundance index actually increased error on average. We may have to wait many years for new surveys to provide substantial improvements in status estimates, or work to expand access to long-running existing surveys that have yet to be fully utilized in fisheries assessment [@maureaud2020].

```{r voi-plot, fig.cap="Posterior probability distributions of estimated effect of different data types on root mean squared error of B/B~MSY~ in the most recent 5 years of data available for each model fit. Distribution is full posterior probability distribution. Point is median, thicker black section inner 66th quantile of the posterior, the thinner black line the 95th. Change is relative to the mean performance of a catch-only heuristic model."}
b_voi_plot + 
  geom_vline(aes(xintercept = 0), alpha = 0.75)
```

# Discussion

<!-- XX somewhere in here make clear that you're not learning anything from the catch data XX -->

<!-- XX Acknolwedge the need for action the the frustration of being told "get more data" XX -->

<!-- Global-level assessment are critical for guiding management agendas for the world's oceans. Despite this need, and despite advances in stock assessment methods, our understanding of the world's fisheries remains murky in many parts of the world. Numerous efforts have sought to resolve this problem through development of new modeling methods. These studies have ranged from simple heuristic algorithms to superensemble modeling, but while these studies have advanced our knowledge and motivated important conversations about the state of unassessed fisheries, each has demonstrable shortcomings as an answer for global fisheries assessment. However, a growing number of broadly (if not globally) distributed datasets have become available recently, leading us to ask whether using these data to move beyond "catch-only" models for global assessment would produce more reliable outcomes. While we demonstrate that these data can provide value above and beyond the catch histories alone, addition of these data alone does not substantially clarify the picture of global fisheries status.   -->

Global-level assessment are critical for guiding management agendas for the world's oceans, and tracking critical indicators such as the United Nations Sustainable Development Goals. Despite this need, and despite advances in stock assessment methods and available data, we show that our understanding of the world's fisheries remains uncertain in many parts of the world. While in some cases addition of globally available data, such as quality of fisheries management or effort reconstructions, provided value above and beyond catch histories alone (Fig.\@ref(fig:cs-plot)), at the global level models fit using each of the available datasets, besides the RAM-derived indices, produced biased and imprecise estimates of stock status (Table.\@ref(tab:perf-tab)).

What quality of assessment is needed and what constitutes a meaningful improvement in assessment quality depends on the needs of those using the assessment outputs. It may be that for particular regions, species, or uses the results presented here or in other past global analyses are sufficient. In some instances using the data presented here did provide some improvement over use of catch-only style methods; the difficulty comes in attempting to apply data types uniformly across the globe. While it is unreasonable to expect any global-scale data to be able to perform as well as detailed stock assessments reported in RAM, or that data-limited methods would perform well for every individual stock, our hope would be that a data-limited approach based on globally available data sources would be able to correctly capture general patterns in stock status in time and space. That none of the datasets collected here can achieve that, and that our test on the RAM data suggest that model misspecification is not the primary culprit, tells us that improvements in estimates of global stock status must come from improvements in the quality and use of data themselves.

We chose to test the performance of methods against estimated values reported in RAM. A reasonable critique of this choice is that unassessed stocks, on which these methods would actually be used, are likely to have vastly different dynamics than the heavily managed stocks in RAM. The clear and systemically poor performance of the methods tested here when applied to RAM stocks would require though that these methods have massively lower bias and higher accuracy for unassessed fisheries than RAM stocks if they are to be expected to provide reasonable picture of global stock status. Free et al. 2020's [@free2020] simulation testing of the types of methods included here suggests that this is unlikely to be true. 

<!-- Our estimates of global stock status vary wildly depending on which source of data we use. Why not simply pick the best source of data, or use all the available data, and use that to update our estimate of global stock status, under the grounds that that is the best available information? Unfortunately, it is not clear that we can evaluate which source of data provides the best fit; examination of each shows strengths and weakness that are not easily comparable (Fig.\@ref(fig:mape-map)). Globally available effort data from @rousseau2019 allows us to create local indices of abundance based on catch histories but carries a host of critical assumptions, namely that the same effort history applies to all fisheries in the region, or country if country level effort data are used. These CPUE indices are also extremely sensitive to assumptions around rates of change in catchability. The fisheries management index has some ability in predicting stock status (Fig.XX), but out-of-sample testing reveals limitations. Swept-area ratios have a strong relationship with fishing mortality rates, but only for comparable fisheries; it is unclear how good a proxy this measure is for non-demersal stocks. None of these data, or combinations thereof, was able to satisfactorily match the FAO's SOFIA assessments, or the assessments presented in RAM (XX RAM matches? need to add an analysis: match stocks from SOFIA to RAM stocks where possible, plot comparison).  -->

Our results do not imply that the kinds of broadly available data presented here are not valuable under the right conditions. The FMI and SAR based priors are an improvement over catch-only models in applicable situations (i.e. those that sufficiently resemble the data on which the regressions were trained, Fig.\@ref(fig:cs-plot)). Effort data such as those reconstructed by Rousseau et al. 2019 [@rousseau2019] can help distinguish between regions with similar catch histories but different effort trajectories, and may be quite useful as indices of abundance for areas with good knowledge of rates of evolution of fishing technology and a broadly selective fishing fleet. Despite not adding a great deal in terms of performance at the global scale, swept-area-ratio was the strongest predictor of F/F~MSY~ of any of the datasets we explore on an individual stock basis, a Bayesian R^2^ value of `r round(mean(rstanarm::bayes_R2(sraplus::sar_models$fit[[3]])),2)`.

But, we must simultaneously consider data quality and resolution: applying one SAR value to all stocks in a region, even if that SAR value can provide valuable information for a subset of fisheries, causes inaccurate estimates of stock status when applied too broadly. Our analysis does not show that the data considered here are without value, but that attempting to indiscriminately apply these data to all areas results in meaningfully incorrect estimates of stock status for regions whose nature does not match the assumptions needed to apply these data sources.

Our value-of-information analysis also shows though the high utility of having access to even a recent snapshot of F/F~MSY~ (Fig.\@ref(fig:voi-plot)). Swept area ratios, Fisheries Management Index scores, or other similar metrics can be used to construct priors on fishing mortality rates, though care must be taken in applying them at the appropriate spatial resolution. Another avenue would be to prioritize the development of a global repository for length and age composition data. Given appropriate conditions, these length measurements can be used to estimate local fishing mortality rates [@hordyk2016; @prince2019; @rudd2017]. While length-based assessments come with a host of assumptions and pitfalls, properly implemented in some fisheries with appropriate life histories these methods may provide an overlooked source of information on fisheries at a global scale, at least as an improvement over relying on catch-only or regional proxies alone. Such a database could be used to construct stock or stock complex specific priors on fishing mortality for particular regions around the globe, which could meaningfully improve our understanding of global fisheries, particularly when paired with catch data and where possible indices of abundance [@thorson2015f; @rudd2017].

<!-- Using catch data alone does not reveal about recent stock status beyond what is encoded in our priors and functional forms. So if we had good estimates of B/B~MSY~ our job would already be done without any need to run something like `sraplus` (except to derive other quantities of interest). Given the demonstrated value of F/F~MSY~ values in improving estimates of stock status, and the increased feasibility in estimating F/F~MSY~ at a local scale relative to B/B~MSY~, how might we go about obtaining estimates of fishing mortality rates at a global scale? We have demonstrated one potential approach here; fisheries management index and swept area ratio values both provide reasonable predictions of F/F~MSY~ for individual fisheries (see Supplemental Information). While assigning mean FMI and SAR values at the taxonomic and regional level as we did in Fig.\@ref(fig:mpe-map)-\@ref(fig:acc-map) did not perform particularly well, efforts to assign FMI and SAR values to individual stocks or appropriate stock complexes might be more fruitful. -->

We must also prioritize collection and curation of fish population survey data worldwide. Repositories of fishery-independent survey data would be immensely beneficial, such as those maintained by [FishStat](https://james-thorson.github.io//). Recent research confirms that there are bottom trawl data to support analysis of biomass-trends since 2001 and potentially earlier in many regions [@maureaud2020], and survey data are available for more stocks than have previously had stock assessments. Effort reconstructions such as those utilized here may help create fishery-dependent abundance indices in some instances, and going forward datasets such as those compiled by [Global Fishing Watch](https://globalfishingwatch.org/) in combination with the reconstruction approaches of [@rousseau2019] might allow us to construct and use timeseries of fishing effort specific to particular areas, fleets, and species complexes

Expanded training of fisheries scientists around the globe is another critical need. Even were we to dramatically expand the amount and types of data available for global assessment, individual fisheries and regions will need to make informed decisions about which sources of data may be applicable and which not, and to critically evaluate the results of any model based on local expertise. This is why stock assessments even in the data-rich world are not an automated process; the real challenge is often not in fitting a model to data but in understanding how best to use the data and the quality and limitations of the model used. Empowering a global network of fisheries scientists through training and peer-support would help local experts make the most of available data, ensure the reliability of newly collected data, and improve the interpretation of assessment results.

The coming decades are a critical time for the future of fisheries and ocean health. Achieving the United Nations Sustainable Development Goal 14 for the conservation and sustainable use of the world's oceans depends on our ability to effectively assess the status of fish stocks around the world. The RAM Legacy Stock Assessment Database combined with the FAO's expert elicitation of status for select stocks have dramatically improved our understanding of global fisheries in recent years. However, this process still leaves a substantial number of fisheries and global catch unassessed. Numerous catch-based data-limited approaches have attempted to fill that gap, and while these efforts have advanced our knowledge and interest in unassessed fisheries, none have yet been able to provide a clear solution to this problem. Improving estimates of global stock status depends on investing in an improved and expanded global network of fishery data and fisheries scientists.

# Methods

All analysis were conducted in the R programming language [@rcoreteam2019]. Model fitting was conducted using Rcpp [@eddelbuettel2011] and stan [@carpenter2017], implemented through Template Model Builder [@kristensen2016] by the tmbstan package [@monnahan2018]. The sraplus package is publicly available at [github.com/danovando/sraplus](https://github.com/DanOvando/sraplus), and all materials needed to fully reproduce this manuscript are available at [github.com/DanOvando/assessing-global-fisheries](https://github.com/DanOvando/assessing-global-fisheries).

sraplus contains too many options to cover within this methods section. We encourage readers to explore the documentation available at the package website at www.github.com/danovando/sraplus. Below we describe the structure of the population model underpinning sraplus, the estimation models used, and the construction of priors used in this paper.

## Population Model

The core of sraplus is a Pella-Tomlinson [@pella1969] production model constructed in the manner of [@winker2018]. While models of these kinds abstract away many important details of fish biology and fleet behavior, they are the highest resolution model that the potential data evaluated here will support. The purpose of sraplus is not to make substantial improvements in the fitting of surplus production models, but to provide a flexible tool for exploring the impacts of adding different kinds of data and priors on estimates of fishery status

The population growth equation is

\begin{equation}
f(x)=\begin{cases}
B_{t + 1} = \left(B_{t} + B_{t}\frac{r}{m - 1}\left(1 - \left(\frac{B_t}{K}\right)^{m- 1}\right) - c_t\right)p_t
, & \text{if $B_t>0.25 \times K$}.\\
B_{t + 1} = \left(B_{t} + \frac{B_{t}}{0.25 \times K}\left(B_{t}\frac{r}{m - 1}\left(1 - \left(\frac{B_t}{K}\right)^{m- 1}\right) - c_t\right)\right)p_t, & \text{otherwise}.
\end{cases}
(\#eq:pt)
\end{equation}

Where $B_t$ is biomass at time *t*, *r* is the intrinsic growth rate, *m* is the scaling parameter that allows for the ratio of B~MSY~/K to shift. When *m* is two B~MSY~ / K = 0.5, lower values of *m* shift the production function left, higher values right. $\pmb{c}$ is a vector catches, and $\pmb{p}$ is vector of process errors. Growth rates can become unrealistically large when the population reaches low sizes under the Pella-Tomlinson model. We deal with this problem by following the methods described in [@winker2018]. to reduce the production of the population when it falls below a threshold of 25% of carrying capacity.

We allow for process error *p* (in the manner of the stochastic stock reduction analysis error suggested by [@walters2006]). This allows the population dynamics to deviate from the exact values given by the Pella-Tomlinson operating model, while still conforming to the assumptions of this model on average. Incorporation of process errors is useful for two reasons: (1) when you have an abundance index, process errors can reduce bias arising from lack of fit in a deterministic SRA whenever dynamics are poorly explained by catch-history alone, and (2) with or without an abundance index (or other info), the stochastic portion is necessary to get good uncertainty intervals (i.e., with close to nominal coverage, see [@thorson2018]).

Process error *p* is assumed to be log-normally distributed, such that

\begin{equation}
  p_t \sim e^{normal\left(-\sigma_{proc}^2/2,\sigma_{proc}\right)}
(\#eq:procerror)
\end{equation}

## Estimation Model

All of our estimates are Bayesian in nature. We can break the use of sraplus into two distinct categories: with data and without. By "data", we refer to measurements which are used to confront model estimates within a likelihood function. In our context, these include fishery-independent survey data, or a CPUE index. When there are no data, the model amounts to filtering priors through the model (the combination of the Pella-Tomlinson operating model and the catches for the stock in question, along with any fixed parameters). Under this mode, the model is essentially a stock-reduction analysis model, in the manner of [@walters2006], in which we ask, which combinations of prior probability distributions of parameters do not crash the population (i.e. results in biomass less than catches in any time step in the fishery's history), given the constraints of the population model and the catches. This step updates the prior distribution of population parameters by eliminating combinations of priors that are impossible for a given catch history and a specified functional form.

The full list of estimable parameters are listed in Table.\@ref(tab:param-tab). *r* and *K* are the only two parameters that are always estimated. Estimation of every other parameter can be turned on or off. When estimation is turned off estimable parameters are fixed at their initial values, which can either be set to model defaults or specified by the user. For our main sets of results (everything excluding the value of information analysis), the estimated parameters are *r*, *K*, $\sigma_{obs}$, $\gamma$, and *B0*. *q* is also estimated when needed.

```{r param-tab}
cd <- data_frame(Parameter = "Carrying Capacity", Abbreviation = "$K$", `Default Prior` = "Prior predictive tuning") %>%
  rbind(c("Growth rate", "$r$", "Thorson, 2020 [@thorson2020] updated by prior predictive tuning")) %>%
  rbind(c("Shape parameter", "$m$", "Drawn from Thorson et al. 2012 (@thorson2012)")) %>%
  rbind(c("Catchability", "$q$", "$logn(1e^{-3}, 1)$")) %>%
  rbind(c("Observation Error", "$\\sigma_{obs}$", "$logn(.05,1)$")) %>%
  rbind(c("Ratio of process to observation error", "$\\gamma$", "$logn(.5,0.25)$")) %>%
  rbind(c("Initial State", "$B0$", "Posterior probability dist. of catch-based regressions"))

 
knitr::kable(
  cd,
  align = "l",
  escape = F,
  row.names = F,
  caption = "Name, abbreviations, and priors distribution for parameters potentially estimated by sraplus in this manuscript.",
  format = "pipe"
) %>%
  kableExtra::kable_styling(full_width = T, font_size = 9) %>%
  kableExtra::row_spec(0, bold = T)
```

sraplus can be run in two forms: either as a stock reduction analysis [SRA, @walters2006], or fit to an index of abundance (fishery dependent or independent). Unless there is an abundance index to fit to the model runs as a stock reduction analysis. A stock reduction analysis works by specifying prior distributions on population parameters and critically the recent state of the fishery. sraplus allows users to specify the most recent status in units of depletion, B/B~MSY~, F, or F/F~MSY~. We then sample from the prior distributions of the population model parameters and apply those to the production model, along with the catch history. Any run that results in the collapse of the population (catch greater than biomass in any time step) is immediately rejected. The remaining viable draws from the prior distributions are sampled in proportion to the supplied prior on recent stock status. Any model results based on data sources listed in Table.\@ref(tab:dat-desc) that do not contain "cpue" or "RAM data" are estimated through stock reduction analysis. All SRA style runs in our paper sampled 2,000 draws of the prior-predictive distribution from a total of 1e6 candidate draws.

When an index of abundance is available the model estimates the posterior probability distributions of the estimated and transformed parameters using Hamiltonian Monte Carlo implemented in stan [@standevelopmentteam2018] accessed through the `tmbstan` interface [@monnahan2018]. By default the model uses 2000 draws with a 1000 step warm-up and one chain. Any detailed fit for a particular fishery would likely use more draws and chains, but we verified that this sampling routine produced an acceptable tradeoff of speed and convergence criteria. The model fits to a direct estimate of abundance (e.g. a fishery independent survey or a standardized catch-per-unit-effort index), the likelihood is

$$log(a_t) \sim normal(f(r,K,m,B0,\pmb{p},\pmb{c}) \times q, sigma_{obs})$$

where *f* is the Pella-Tomlinson production model (Equation.\@ref(eq:pt)). When an effort index is available, sraplus constructs an index of abundance based on the catch and effort data. [@rousseau2019] measure an index of abundance as catch divided by their effort index, either nominal or effective (assuming the 2.6% annualized technology creep). This rate of technology creep assumes that every unit increase in effort is log-linearly greater than the unit of effort before it. When effort increases dramatically above historic levels, this can create a CPUE index that decreases faster than the true population. This is due to the fact that the marginal fishing mortality produced by increasing unit of efforts increases decreases as effort approaches infinity (since fishing mortality is bounded between 0 and 1). To accommodate this, we generate a catch per effective harvest rate index of abundance, as

$$cpue_t = \frac{c_t}{(1 - e^{-f_t})}$$

$$f_t = q_tE_t$$

Where $q_t$ can has a technology creep component $\tau$

$$q_t = q_{t-1} \times (1  + \tau)$$

We then fit to the index of abundance per

$$log(cpue_t) \sim normal(f(r,K,m,B0,\pmb{p},\pmb{c}), \sigma_{obs})$$

### CMSY

In addition to the results from sraplus, we include a set of results produced by the CMSY method [@froese2017]. For computational efficiency, we used a ported version of the CMSY model available at <https://github.com/DanOvando/portedcmsy>. The only modification made is to convert the underlying population model to C++ for faster computation. For each stock we used all the default options provided by CMSY, except for resilience, which was pulled from the vulnerability scores from FishBase accessed through `rfishbase` [@boettiger2012]. Vulnerability scores greater than 66 were scored as low resilience, between 33 and 66 medium resilience, and lower than 33 high resilience.

In the absence of an index of abundance CMSY and sraplus are conceptually the same: Both sample from prior distributions of life history and stock status conditional on the stock not collapsing given a catch history and a functional form for the population growth equation. The core different between CMSY and sraplus as utilized here then is that when we refer to CMSY we mean CMSY run using the default heuristics used by the algorithm to construct priors on initial, intermediate, and terminal stock status. In contrast, sraplus fit using for example FMI data uses the empirical models described here to generate priors on stock status. In addition, all sraplus runs use a prior-predictive tuning procedure to resolve issues related to Borel's paradox, described below.

## Priors

Priors for all estimable parameters can be left at default values or set by the user. The shape parameter is usually not reliably estimable given available data for surplus production models, however, Thorson et al. 2012 [@thorson2012] provides estimate the ratio of *B~MSY~* to *K* for many fish taxa. While we estimate *m* by default throughout the results presented here, we use highly informative priors for the shape parameter based on Thorson et al. 2012 [@thorson2012] for the genus of the species in question.

We address two critical features of prior use in sraplus below: tuning of the prior-predictive distribution and translation of outside data into priors usable by sraplus.

### Prior Predictive Tuning

Suppose that the only thing we observe from a fishery is a catch history. Assuming Pella-Tomlinson population dynamics, the only thing we can learn from this catch history alone is the set of model parameters that ensure that the population still exists and never collapsed in the past. We can think of this as a binomial process in which we fit a model of the population, conditional on catches, to the fact that we know that population existed in each time step of the catch history. Beyond that though, baring additional information or model assumptions we have no way of knowing whether these catches represent a substantial proportion of a small population or a minuscule fraction of a massive population; all we know is that the current population must be greater than zero.

In the absence of any data to fit to, the SRA algorithm works by assuming that we know current stock status, and then finds feasible parameters to satisfy that belief. This creates a problem for the Bayesian nature of our analysis though. Consider a production model with two parameters, a growth rate *r* and a carrying capacity *K*. Once we specify prior distributions on *r* and *K*, and then apply these distributions to our model (the shape of the production function along with the catch histories), we have implicitly provided a prior on the status of the stock in all time periods, since each unique combination of *r* and *K* together with the model and the catch history produces a deterministic stock status in each time step. Doing so places essentially two priors on recent stock status: one implicit prior through the population parameter priors, and one explicit through the users perception of recent stock status, creating a problem termed Borel's Paradox (See Poole and Raftery 2000 [@poole2000] and references therein for a discussion of Borel's Paradox in a fisheries context). This may seem like an academic concern, and indeed in our experience when the data are sufficiently informative the Bayesian version of our model subject to Borel's paradox produces effectively identical results to those produce by the same model fit by maximum likelihood. However, particularly for the SRA version of sraplus, Borel's Paradox poses a particular problem.

The SRA algorithm works in two steps. First, the algorithm rejects any draws that resulted in the collapse of the population (biomass less than catch in a given timestep). From there a standard SRA would sample from the priors in proportion to the stated prior on recent stock status. If the bulk of the prior on terminal stock status was concentrated at 50% of *K*, combinations of *r* and *K* that produce terminal stock status near 50% of *K* are sampled proportionally more frequently. However, lower values of terminal stock status have fewer candidate values of *r* and *K*, since it becomes harder and harder to find viable pairs that come close to but do not crash the population at any time step. Conversely, in the absence of constraints higher values of stock status have infinite combinations of plausible *r* and *K* combinations: since under this model the population cannot be greater than carrying capacity, as for example *K* approaches infinity terminal stock status asymptotes at close to 100% of *K*. The net result of this is that even though individual combinations of *r* and *K* that produce higher stock status than the mean of the prior on recent stock status individually have lower probability of being sampled, there are many more opportunities for the lower-probability events that produce higher stock status to be sampled. As a result, the post-model-pre-data prior on terminal depletion will always be higher under this method than the supplied prior on stock status.

We use an approximation to this problem here, similar in spirit to Bayesian melding [@poole2000]. Our solution amounts to a two-step SIR algorithm. We first run the standard SIR algorithm as described above. We then break the resulting draws into bins based on terminal stock status, and calculate the mean sampling probability of each bin.

$$p(bin_i) = \frac{1}{N_i}\sum_{n = 1}^{N_i}{p(b_{n,i})}$$

We then divide the sampling probability of of bin *i* evenly among each of the draws within that bin *n*

$$p(n_i) = \frac{p(bin_i)}{N_i}$$

And we then perform a second SIR algorithm but now sampling each observation $n_i$ in proportion to $p(n_i)$. The net result of this is a post-model-pre-data distribution of parameters *r* and *K* that produce a distribution of recent stock status that roughly matches the supplied prior on recent stock status. In effect, this process answers the question "given the model, what combinations of parameters produce my prior on recent stock status". This is only an approximate solution, but it helps ensure that the post-model-pre-data distribution of stock status much more closely matches the stated prior on recent stock status, and reduced the positive bias resulting from use of the raw SRA algorithm (Fig.\@ref(fig:bias-plot), Fig.S1).

```{r bias-plot, fig.cap = "Post-model-pre-data distribution of depletion (biomass relative to carrying capacity) from raw SRA algorithm (untuned, top row), from SRA algorithm with approximate tuning applied (tuned, middle row), compared to the supplised prior on depletion (bottom row). Black vertical line indicates median value. "}

id = unique(ram_comp_data$stockid)

ex <- ram_data %>% 
  filter(stockid %in% id[[1]]) 

# fit using catch heuristic

co_driors <- sraplus::format_driors(taxa = unique(ex$scientificname),
                                 catch = ex$catch, 
                                 years = ex$year,
                                 terminal_state = 0.25,
                                 terminal_state_cv = 0.5,
                                 b_ref_type = "k")

biased_co_fit <- sraplus::fit_sraplus(driors = co_driors, tune_prior_predictive = FALSE,
                                      estimate_shape = FALSE, estimate_proc_error = TRUE)

biased_depletion <- biased_co_fit$fit %>% 
  filter(variable == "dep_t") %>%
  filter(year == max(year)) %>% 
  mutate(set = "Untuned Post-Model-Pre-Data") %>% 
  select(year, value, set)


co_fit <- sraplus::fit_sraplus(driors = co_driors, tune_prior_predictive = TRUE,
                                      estimate_shape = FALSE, 
                               estimate_proc_error = TRUE)

tuned_depletion <- co_fit$fit %>% 
  filter(year == max(year), variable == "dep_t") %>% 
  mutate(set = "Tuned Post-Model-Pre-Data") %>% 
  select(year, value, set)

prior <- tuned_depletion %>% 
  mutate(value = rlnorm(n(), log(0.25), 0.5)) %>% 
    mutate(set = "Prior")

comps <- biased_depletion %>% 
  bind_rows(tuned_depletion) %>% 
  bind_rows(prior) %>% 
  group_by(set) %>% 
  mutate(valrank = percent_rank(value)) %>% 
  filter(between(valrank, .05, .95))

comps %>% 
  ggplot(aes(x = value, y = set)) + 
  ggridges::geom_density_ridges(alpha = 0.9,
                                quantile_lines = TRUE, quantiles = 2) +
  scale_x_continuous(limits = c(0, 1.2), name = "Depletion (B/K)") + 
  scale_y_discrete(name = '')


```

### Priors Informed by Outside Data

Along with allowing users to supply their own priors, the sraplus package contains three built-in methods used in this manuscript for converting information on stock status from additional outside data into a form usable as a prior by sraplus. We paired data on catch histories, swept area ratio (SAR), and fisheries management index (FMI) with estimates of stock status from the RAM legacy stock assessment database. We then trained a model of the general form $log(status) \sim normal(variable,\sigma)$ for each of these three data types. Given values of these variables for a new fishery then, sraplus uses the fitted model to generate posterior predictive distributions of stock status based on these data, which can then be used as priors on stock status by sraplus.

All prior regression models where tested by out-of-sample predictive power, and where competing models were considered the final model was chosen by leave-on-out validation [@vehtari2017]. The final models are intended as a reasonably robust means of translating available data (catch histories, FMI, and SAR values) into a form usable by sraplus. Given the scope of this analysis, we do not claim that the presented regressions are the best possible model relating these data with the fishery status indicators of interest. Rather, each regression was tested to ensure that it is unlikely that, given the same data, an alternative model would perform substantially better than those presented here.

#### Catch-Only Priors

Many of the current methods for estimating global stock status of unassessed stocks are based on predicting stock status from characteristics of the catch history [@costello2012b; @costello2016a; @pauly2007; @rosenberg2018]. While these catch-only methods have been shown to have serious shortcomings [@free2020], we include them as a point of reference given their ubiquity in the global assessment literature.

We used data from the RAM Legacy Stock Assessment Database to estimate a regression of stock status as a function of catch history characteristics. To facilitate the process, we first fit a spectral clustering algorithm to the scaled catch histories of fisheries in RAM, in order identify four possible clusters of catch history types within the the data. Emergent clusters show for example one built around a downward "one way trip" style catch histories, others with a boom and bust pattern, others with stable but fluctuating catches.

We then trained a classification algorithm to predict which catch cluster a given fishery would fall into based on the shape of its catch history. This algorithm was then used to assign fisheries to one of the four identified catch history types, and the catch history type was then used as a hierarchical term within our catch-based regressions (where *s* refers to a smoothing term). For the first regression, we restrict the data to the first year of data available for each fishery *i*, in order to estimate initial stock status

$$log(value_i) \sim normal(s(\frac{first(catch)}{max(catch)} | cluster_i) + s(log(lengthi)|cluster_i) + 1, \sigma)$$

For the second regression, we included data for all available years *y* for fishery *i*. The model is then used to construct a prior on fishery status in the terminal year of the data

$$log(value_{i,y}) \sim normal(s(fyear | cluster_i) + s(\frac{catch_{i,y}}{max(catch_i)} | cluster_i) + cluster_i, \sigma)$$

where *fyear* is the year of the fishery, starting from 0.

#### Fisheries Management Index Priors

The Fisheries Management Index (FMI), as presented in [@melnychuk2017], utilizes surveys filled out by regional experts to score a fishery against a set of 46 specific questions for individual species about what elements of fisheries management were in place. These questions are then aggregated into broader categories of science, enforcement, management, and socioeconomic. The higher the score, the better the expert judges that a given metric is met in that fishery. Importantly, FMI surveys can be filled out in the absence of stock assessments. This allows us to explore how FMI values map onto stock status, and explore the ability then to use FMI scores to produce priors on stock status for unassessed fisheries (in a manner similar to [@osio2015] and [@cope2015]).

The final selected model relating FMI variable to stock status metrics was a generalized additive model (GAM) of the form

$$log(value_i) \sim N(s(research_i) + s(management_i) +
s(enforcement_i) + s(socioeconomics_i) + \frac{catch_i}{max(catch)_i)} + 1,\sigma_{SAR})$$

#### Swept Area Ratio Priors

[@amoroso2018] provides an extensive database of trawling footprints throughout the world, including both regions heavily covered by stock assessments and largely unassessed areas. This makes the trawl footprint data an ideal candidate for supporting global stock assessment efforts. As illustrated in [@amoroso2018], there is an evident positive relationship between the swept area ratio (SAR,the total annual area trawled divided by the total area of the region) and U/U~MSY~. Note that SAR can be greater than 1 since the same area can be trawled multiple times in a year, e.g. if all trawl-able areas are trawled twice a year then the SAR will be 2. Also note the skewed distribution of SAR values with most concentrated well below 1 and only a handful above 1.

The final selected model relating SAR to to stock status metrics was

$$log(value_i) \sim normal(s(SAR_i) + s(\frac{catch_i}{max(catch)_i)}) + 1,\sigma_{SAR}) $$

## Value of Information Calculations

What sources of data might provide the greatest value in improving our estimates of global stock status? We fit 3,000 sraplus models to randomly sampled fisheries from RAM, each time varying the kind and quality of data made available to the model, and what parameters the model estimated. We then calculated the root-mean-squared-error (RMSE) between the observed and predicted B/B~MSY~ over the most recent five years of each fit, and then fit a regression to these data to estimate the posterior probability of the effect of different data types and model states on RMSE (Fig.\@ref(fig:voi-plot)).

The value-of-information (VOI) calculations presented in Fig.\@ref(fig:voi-plot) help illustrate what types of data may be most beneficial to acquire at a global scale if we are to improve our knowledge of the state of global fisheries. The VOI analysis was performed by using sraplus to generate estimates of stock status (B/B~MSY~) for stocks in the RAM legacy stock assessment, and comparing the estimated values to the values reported in RAM. We generate fits for 3000 combinations of a RAM stock and available data. For any one draw, we randomly sample a RAM stock and a list of available data and data quality. For example, we might sample stock *A* with information on recent fishing mortality rates for the first iteration, and stock *A* again for the second iteration but now with information on recent fishing mortality rates and a recent index of abundance. The result is a set of model performance estimates where the characteristics of the stock and the data made available to the model are randomized.

Using this set of fits, we assess performance as the root-mean-squared-error of B/B~MSY~ over the most recent 5 years of the fishery, in order to evaluate the ability of the model to capture the recent trends in stock status and not just the most recent year. We evaluate the contributing of each data type to RMSE using a Gamma GLM with a log link of the form

$$rmse \sim  Gamma(\pmb{\beta}{\pmb{X}} + (1 | stock), shape, scale)$$

Where $\pmb{\beta}$ is the vector of coefficients associated with the matrix of dummy variables marking the use of different data types in the vector $\pmb{X}$

# References

::: {#refs}
:::

# Supplementary Information

\renewcommand{\thefigure}{S\arabic{figure}}

\setcounter{figure}{0}

\renewcommand{\thetable}{S\arabic{table}}

\setcounter{table}{0}

## Data Sources Used


```{r dat-desc}
dat_description <- tribble(~`Data Name`, ~Description,
        "RAM Index", "Fit to abundance index from RAM",
        "SAR", "Prior on terminal F/Fmsy set by regional swept area ratio",
        "FMI", "Prior on terminal F/Fmsy set by regional fisheries management index scores",
        "EFfective CPUE", "Fit to CPUE index created from RAM catch and regional effort index. 2.6% technology creep",
        "Effective CPUE+", "Fit to CPUE index created from RAM catch and regional effort index with priors informed by SAR and FMI. 2.6% tech. creep",
        "Nominal CPUE", "Fit to CPUE index created from RAM catch and regional effort index. 0% tech. creep",
         "Nominal CPUE+", "Fit to CPUE index created from RAM catch and regional effort index with priors informed by SAR and FMI. 0% tech. creep",
        "Guess", "Priors on terminal B/Bmsy randomly sampled from .4,1,1.6")

knitr::kable(dat_description,
             caption = "Data sources used for terminal stock status estimate",
             format = "pipe")
# %>%
#   kableExtra::kable_styling(full_width = T, font_size = 9) %>%
#   kableExtra::row_spec(0, bold = T)
```


## Sample Prior Posterior Plots

```{r ppplot, fig.cap="Prior posterior plots of fits for case study fishery in Fig.6"}

a = get_prior_posterior(co_fit, co_driors)

a$prior_posterior %>% 
  ggplot(aes(x = variable, y = mean, ymin = lower, ymax = upper, color = source)) + 
  geom_pointrange(position = position_dodge(width = 0.1)) + 
  facet_wrap(~variable, scales = "free") + 
  theme(axis.text.x = element_blank()) + 
  scale_color_discrete(name = '') + 
  scale_y_continuous(name = "Value") + 
  scale_x_discrete(name = '') + 
  theme_minimal()


```

## Population Model

The core of our model is a Pella-Tomlinson [@pella1969] production model in the manner of [@winker2018]. While models of these kinds abstract away many important details of fish biology and fleet behavior, they are the highest resolution model that the potential data evaluated here will support.

```{r si-prior-tab}
cd <- data_frame(Parameter = "Carrying Capacity", Abbreviation = "K", `Default Prior` = "$logn(10\\times{max(catch)},4)$") %>%
  rbind(c("Growth rate", "r", "$logn(r_{fishlife}, \\sigma_{r,fishlife})$")) %>%
  rbind(c("Shape parameter", "m", "$logn(1.01, 0.25)$")) %>%
  rbind(c("Catchability", "q", "$logn(1e^{-3}, 0.3)$")) %>%
  rbind(c("Observation Error", "$\\sigma_{obs}$", "$logn(.05,2)$")) %>%
  rbind(c("Process Error", "$\\sigma_{proc}$", "$logn(.05,0.5)$")) %>% 
  rbind(c("Tech Creep", "$creep$", "$logn(0.025,0.2)$"))

 
knitr::kable(
  cd,
  "latex",
  align = "l",
  booktabs = TRUE,
  escape = F,
  row.names = F,
  caption = "Potential parameters included in sraplus, abbreviations, and default priors"
) %>%
  kableExtra::kable_styling(full_width = T, font_size = 9) %>%
  kableExtra::row_spec(0, bold = T)
```

The population growth equation is

\begin{equation}
  f(x)=\begin{cases}
      B_{t + 1} = \left(B_{t} + B_{t}\frac{r}{m - 1}\left(1 - \left(\frac{B_t}{K}\right)^{m- 1}\right) - \hat{c_t}\right)p_t
, & \text{if $B_t>0.25 \times K$}.\\
     B_{t + 1} = \left(B_{t} + \frac{B_{t}}{0.25 \times K}\left(B_{t}\frac{r}{m - 1}\left(1 - \left(\frac{B_t}{K}\right)^{m- 1}\right) - \hat{c_t}\right)\right)p_t, & \text{otherwise}.
  \end{cases}
  (\#eq:sihockey)
\end{equation}

## Prior Generating Regressions

### Swept Area Ratio

```{r sar-fit, fig.cap = "Observed (x-axis) vs posterior predictive (y-axis) F/F~MSY~ for regression of swept area ratio (SAR) on F/F~MSY~"}
fit <- sraplus::sar_models$fit[sraplus::sar_models$metric == "mean_uumsy"][[1]]

fit_data <- fit$data

pp <- posterior_predict(fit, draws = 1000)

r2_plot <- tibble(r2 = bayes_R2(fit)) %>% 
  ggplot(aes(r2)) + 
  geom_histogram() + 
  labs(subtitle = "B) Bayesian R2")

pi_plot <- ppc_intervals(y = fit_data$log_value, yrep = pp, x = fit_data$log_value) + 
  scale_x_continuous(name = "Observed Log F/Fmsy") + 
  scale_y_continuous(name = "Posterior Predictive F/Fmsy") +
  labs(subtitle = "A) Observed vs. Posterior Predictive") +
 pub_theme

pi_plot + r2_plot

```

### Fisheries Management Index

```{r fmi-fit, fig.cap = "Observed (x-axis) vs posterior predictive (y-axis) F/F~MSY~ for regression of fisheries management index (FMI) on F/F~MSY~"}

fit <- sraplus::fmi_models$fit[sraplus::fmi_models$metric == "mean_uumsy"][[1]]

fit_data <- fit$data

pp <- posterior_predict(fit, draws = 1000)

r2_plot <- tibble(r2 = bayes_R2(fit)) %>% 
  ggplot(aes(r2)) + 
  geom_histogram() + 
  labs(subtitle = "B) Bayesian R2")

pi_plot <- ppc_intervals(y = fit_data$log_value, yrep = pp, x = fit_data$log_value) + 
  scale_x_continuous(name = "Observed Log F/Fmsy") + 
  scale_y_continuous(name = "Posterior Predictive F/Fmsy") +
  labs(subtitle = "A) Observed vs. Posterior Predictive") +
 pub_theme

pi_plot + r2_plot
```

## Catch History

```{r catch-reg,fig.cap = "Observed (x-axis) vs posterior predictive (y-axis) B/B~MSY~ for regression of catch on B/B~MSY~"}

fit <- sraplus::catch_b_model

fit_data <- fit$data %>% 
  group_by(stockid) %>% 
  filter(year == max(year))

pp <- posterior_predict(fit, draws = 1000, newdata = fit_data)

r2_plot <- tibble(r2 = bayes_R2(fit)) %>% 
  ggplot(aes(r2)) + 
  geom_histogram() + 
  labs(subtitle = "B) Bayesian R2")

pi_plot <- ppc_scatter_avg(y = fit_data$log_value, yrep = pp) + 
  coord_flip() +
  scale_y_continuous(name = "Observed Log B/Bmsy") + 
  scale_x_continuous(name = "Posterior Predictive B/Bmsy") +
  labs(subtitle = "A) Observed vs. Posterior Predictive") +
 pub_theme


pi_plot + r2_plot
```
